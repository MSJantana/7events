services:
  backend:
    image: msoftsantana/7events:backend-latest
    container_name: 7events-backend
    ports:
      - "4000:4000"
    environment:
      PORT: 4000
      DATABASE_URL: mysql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}
      JWT_SECRET: ${JWT_SECRET}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
    volumes:
      - ./uploads:/app/uploads
    networks:
      - app-network
    restart: always

  frontend:
    image: msoftsantana/7events:frontend-latest
    container_name: 7events-frontend
    environment:
      - VITE_GOOGLE_LOGIN_ENABLED=${VITE_GOOGLE_LOGIN_ENABLED:-true}
      - VITE_API_URL=${VITE_API_URL:-http://localhost:4000}
    networks:
      - app-network
    restart: always

  nginx:
    image: nginx:alpine
    container_name: 7events-proxy
    ports:
      - "80:80"
    command: >
      /bin/sh -c "echo 'events { worker_connections 1024; } http { include mime.types; default_type application/octet-stream; upstream backend { server backend:4000; } upstream frontend { server frontend:80; } server { listen 80; server_name localhost; location /api/ { proxy_pass http://backend/api/; proxy_set_header Host $$host; proxy_set_header X-Real-IP $$remote_addr; proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $$scheme; } location / { proxy_pass http://frontend/; proxy_set_header Host $$host; proxy_set_header X-Real-IP $$remote_addr; proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $$scheme; proxy_http_version 1.1; proxy_set_header Upgrade $$http_upgrade; proxy_set_header Connection \"upgrade\"; } } }' > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
    depends_on:
      - backend
      - frontend
    networks:
      - app-network
    restart: always

networks:
  app-network:
    driver: bridge
